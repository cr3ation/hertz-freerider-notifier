{% extends 'scheduler/base.html' %}
{% load scheduler_extras %}
{% block content %}
<style>
    .section-title { font-weight:600; letter-spacing:.5px; display:flex; align-items:center; gap:.6rem; }
    .section-title svg { width:20px; height:20px; opacity:.85; }
    .glass-card h5 { font-weight:600; }
    .form-card form p { margin-bottom: .75rem; }
    .form-card form label { font-size:.7rem; text-transform:uppercase; letter-spacing:.05em; opacity:.8; font-weight:600; }
    .form-card form input { background:rgba(255,255,255,0.15); border:1px solid rgba(255,255,255,0.35); color:#fff; }
    .form-card form input:focus { box-shadow:0 0 0 .15rem rgba(255,255,255,0.35); }
    .dashboard-grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(330px,1fr)); gap:1.75rem; }
    .subgrid { display:grid; gap:1.75rem; }
    .table thead th { font-size:.7rem; text-transform:uppercase; letter-spacing:.05em; opacity:.75; }
    .badge.notified-badge { background:linear-gradient(135deg,#00c6ff,#00e3ff); }
    .match-badge { background:linear-gradient(135deg,#2ecc71,#6ddf99)!important; }
    .filters-bar input, .filters-bar button { font-size:.75rem; }
    .filters-bar .btn { padding:.35rem .7rem; }
    .stats-pill { background:rgba(255,255,255,0.12); border:1px solid rgba(255,255,255,0.3); border-radius:2rem; padding:.4rem 1rem; font-size:.75rem; font-weight:500; display:inline-flex; align-items:center; gap:.5rem; }
    .stats-pill strong { font-size:.85rem; }
    .pill-group { display:flex; flex-wrap:wrap; gap:.5rem; }
    .divider-soft { height:1px; background:linear-gradient(90deg,rgba(255,255,255,0),rgba(255,255,255,.35),rgba(255,255,255,0)); margin:1.25rem 0; }
</style>

<div class="dashboard-grid mb-4">
    <div class="glass-card p-4 form-card">
        <h5 class="section-title mb-3">Add new alert</h5>
        <form method="post" novalidate>
            {% csrf_token %}
            {{ form.as_p }}
            <button class="btn btn-primary w-100 mt-2" type="submit">Save alert</button>
        </form>
    </div>
        <div class="glass-card p-4">
            <h5 class="section-title mb-3">Your searches</h5>
            <style>
                .searches-wrapper { max-height: 340px; overflow:auto; border:1px solid rgba(255,255,255,0.25); border-radius:1rem; }
                .searches-table { margin:0; }
                .searches-table thead th { position:sticky; top:0; backdrop-filter:blur(16px) saturate(160%); -webkit-backdrop-filter:blur(16px) saturate(160%); background:rgba(255,255,255,0.15); border-bottom:1px solid rgba(255,255,255,0.25)!important; font-size:.65rem; text-transform:uppercase; letter-spacing:.06em; }
                .searches-table tbody tr { transition: background .25s, box-shadow .25s; }
                .searches-table tbody tr:hover { background:rgba(255,255,255,0.08); box-shadow:0 2px 6px -2px rgba(0,0,0,.4) inset; }
                .searches-table td, .searches-table th { border-color:rgba(255,255,255,0.15)!important; vertical-align:middle; }
                .date-pill { background:rgba(255,255,255,0.14); border:1px solid rgba(255,255,255,0.3); padding:.25rem .55rem; border-radius:1rem; font-size:.65rem; font-weight:500; display:inline-block; min-width:88px; text-align:center; }
                .loc-text { font-size:.75rem; font-weight:600; letter-spacing:.3px; }
                .match-badge-small { background:linear-gradient(135deg,#2ecc71,#6ddf99); font-size:.6rem; letter-spacing:.5px; padding:.35rem .55rem; border-radius:1rem; font-weight:600; }
                .match-zero { opacity:.45; font-size:.6rem; }
                .action-col { text-align:right; }
                .btn-delete { --danger-grad: linear-gradient(135deg,#ff4d4d,#ff9966); background:var(--danger-grad); border:none; color:#fff; font-weight:600; font-size:.6rem; letter-spacing:.5px; padding:.35rem .65rem; border-radius:.65rem; box-shadow:0 2px 4px -1px rgba(0,0,0,.35); }
                .btn-delete:hover { filter:brightness(1.1); }
                .empty-row { text-align:center; font-size:.75rem; opacity:.7; }
                .searches-meta { display:flex; justify-content:space-between; align-items:center; gap:1rem; margin-top:.75rem; flex-wrap:wrap; }
                .searches-meta .small { opacity:.75; }
                /* Re-added indicator styling to match live availability */
                .indicator-dot {width:.55rem; height:.55rem; border-radius:50%; display:inline-block; background:#adb5bd; margin-right:.35rem; }
                tr.has-match .indicator-dot { background:#28a745; }
                tr.row-faded { opacity:.55; }
            </style>
            <div class="searches-wrapper mb-2">
                <table class="table table-sm align-middle searches-table">
                    <thead>
                        <tr>
                    <th style="width:26px;"></th>
                            <th style="width:110px;">From</th>
                            <th style="width:110px;">To</th>
                            <th style="min-width:110px;">Origin</th>
                            <th style="min-width:110px;">Destination</th>
                            <th style="width:90px;" class="text-center">Matches</th>
                            <th style="width:70px;"></th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for s in searches %}
                        {% with mc=search_match_counts|get_item:s.id %}
                    <tr class="{% if mc %}has-match{% else %}row-faded{% endif %}">
                        <td><span class="indicator-dot"></span></td>
                        <td><span class="date-pill">{{ s.date_from }}</span></td>
                        <td><span class="date-pill">{{ s.date_to }}</span></td>
                        <td><span class="loc-text">{{ s.origin }}</span></td>
                        <td><span class="loc-text">{{ s.destination }}</span></td>
                        <td class="text-center">
                            {% if mc %}
                                <span class="match-badge-small" title="Current matching routes">{{ mc }}</span>
                            {% else %}
                                <span class="match-zero">0</span>
                            {% endif %}
                        </td>
                        <td class="action-col">
                            <a href="{% url 'delete_search' s.pk %}" class="btn-delete" title="Delete search">Delete</a>
                        </td>
                    </tr>
                        {% endwith %}
                    {% empty %}
                        <tr>
                            <td colspan="6" class="empty-row">No searches yet – add one on the left.</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="searches-meta">
                <div class="small">Total searches: {{ searches|length }}</div>
                <div class="small">Currently matching routes: {{ matching_routes }}</div>
            </div>
        </div>
</div>

<div class="glass-card p-4 mt-2">
                    <style>
                        /* Inline (flytta till separat css om det växer) */
                        .live-table-wrapper {max-height:480px; overflow:auto; border:1px solid #e9ecef; border-radius:.75rem;}
                        .live-table-wrapper thead th {position:sticky; top:0; background:#f8f9fa; z-index:2; box-shadow:0 1px 0 #dee2e6;}
                        .live-availability-table tbody tr td {white-space:nowrap;}
                        .cell-locations {white-space:normal;}
                        .match-badge {font-weight:600;}
                        .row-faded {opacity:.55;}
                        .trip-pill {background:#eef3ff; border-radius:1rem; padding:.15rem .6rem; font-size:.75rem; font-weight:500; display:inline-flex; gap:.35rem; align-items:center;}
                        .notified-badge {background:#0dcaf0;}
                        .filter-active {font-weight:600;}
                        .indicator-dot {width:.55rem; height:.55rem; border-radius:50%; display:inline-block; background:#adb5bd; margin-right:.35rem;}
                        tr.has-match .indicator-dot {background:#28a745;}
                        tr.notified-row .indicator-dot {background:#0dcaf0;}
                    </style>
            <div class="d-flex flex-wrap justify-content-between align-items-start gap-3 mb-3 filters-bar">
                        <div>
                <h5 class="mb-1">Live availability</h5>
                            <div class="small text-muted">{{ matching_routes }} of {{ total_routes }} routes match your searches</div>
                        </div>
                        <div class="d-flex flex-wrap gap-2 align-items-center">
                            <input id="liveSearch" type="text" class="form-control form-control-sm" placeholder="Search location / car" style="min-width:180px;" aria-label="Search live availability">
                            <button id="toggleShowMatches" class="btn btn-outline-success btn-sm" type="button" title="Show only routes matching any search">Only matches</button>
                            <button id="toggleShowNotified" class="btn btn-outline-info btn-sm" type="button" title="Show only routes already notified">Notified only</button>
                            <button id="resetFilters" class="btn btn-outline-secondary btn-sm" type="button" title="Reset filters">Reset</button>
                            <span class="badge bg-secondary" id="liveVisibleCount" title="Visible / total routes">0 / 0</span>
                        </div>
                    </div>
                    {% if api_error %}
                        <div class="alert alert-warning py-2 mb-3"><strong>API error:</strong> {{ api_error }}</div>
                    {% endif %}
                    <div class="live-table-wrapper">
                        <table class="table table-sm align-middle live-availability-table mb-0">
                            <thead>
                                <tr>
                                    <th style="width:26px;"></th>
                                    <th>Origin → Destination</th>
                                    <th>Pickup</th>
                                    <th>Return</th>
                                    <th>Car</th>
                                    <th class="text-end">Trip</th>
                                    <th class="text-center">Matches</th>
                                    <th class="text-center">Notified</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for r in available_routes %}
                                <tr class="route-row {% if r.matches %}has-match{% endif %} {% if r.notified %}notified-row{% endif %} {% if not r.matches %}row-faded{% endif %}">
                                    <td><span class="indicator-dot"></span></td>
                                    <td class="cell-locations" style="min-width:220px;">
                                        <strong>{{ r.origin }}</strong><br>
                                        <span class="text-muted">→ {{ r.destination }}</span>
                                    </td>
                                    <td><span class="d-block small fw-semibold">{{ r.available_at_display }}</span></td>
                                    <td><span class="d-block small text-muted">{{ r.latest_return_display }}</span></td>
                                    <td style="min-width:200px;">
                                        <span class="small">{{ r.car_model }}</span>
                                    </td>
                                    <td class="text-end">
                                        {% if r.distance or r.travel_hours %}
                                            <span class="trip-pill">{% if r.distance %}{{ r.distance|floatformat:0 }} km{% endif %}{% if r.distance and r.travel_hours %}<span class="text-muted">/</span>{% endif %}{% if r.travel_hours %}{{ r.travel_hours }} h{% endif %}</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if r.matches %}
                                                    <span class="badge match-badge" title="Matches">{{ r.matches|length }}</span>
                                        {% else %}
                                            <span class="text-muted">–</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if r.notified %}
                                            <span class="badge notified-badge">Yes</span>
                                        {% else %}
                                            <span class="text-muted">No</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="8" class="text-muted">No current availability.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                                        <div class="d-flex justify-content-between align-items-center mt-2 flex-wrap gap-2">
                                                <p class="text-muted mb-0 small">Updates on page load (auto-refresh can be added later)</p>
                                                <button id="scrollTopLive" class="btn btn-light btn-sm">Top</button>
                    </div>
                    <script>
                        (function(){
                                                    const btnMatches = document.getElementById('toggleShowMatches');
                                                    const btnNotified = document.getElementById('toggleShowNotified');
                                                    const btnReset = document.getElementById('resetFilters');
                                                    const btnTop = document.getElementById('scrollTopLive');
                                                    const search = document.getElementById('liveSearch');
                                                    const visibleCount = document.getElementById('liveVisibleCount');
                                                    const wrapper = document.querySelector('.live-table-wrapper');
                                                    const rows = () => Array.from(document.querySelectorAll('.live-availability-table tbody tr.route-row'));
                                                    let filterMatches = false, filterNotified = false;

                                                    function applyFilters(){
                                                        const term = search.value.trim().toLowerCase();
                                                        let visible = 0;
                                                        rows().forEach(r => {
                                                            const isMatch = r.classList.contains('has-match');
                                                            const isNotified = r.classList.contains('notified-row');
                                                            let show = true;
                                                            if(filterMatches) show = show && isMatch;
                                                            if(filterNotified) show = show && isNotified;
                                                            if(term){
                                                                const txt = r.innerText.toLowerCase();
                                                                show = show && txt.indexOf(term) !== -1;
                                                            }
                                                            r.style.display = show ? '' : 'none';
                                                            if(show) visible++;
                                                        });
                                                        const total = rows().length;
                                                        visibleCount.textContent = visible + ' / ' + total;
                                                        btnMatches.classList.toggle('filter-active', filterMatches);
                                                        btnNotified.classList.toggle('filter-active', filterNotified);
                                                    }
                                                    btnMatches.addEventListener('click', ()=>{ filterMatches = !filterMatches; applyFilters(); });
                                                    btnNotified.addEventListener('click', ()=>{ filterNotified = !filterNotified; applyFilters(); });
                                                    btnReset.addEventListener('click', ()=>{ filterMatches=false; filterNotified=false; search.value=''; applyFilters(); });
                                                    btnTop.addEventListener('click', ()=>{ wrapper.scrollTo({top:0, behavior:'smooth'}); });
                                                    search.addEventListener('input', applyFilters);
                                                    // initial
                                                    applyFilters();
                        })();
                    </script>
                </div>
                    <div class="glass-card p-4 mt-4">
                        <style>
                            .history-wrapper {max-height:340px; overflow:auto; border:1px solid #e9ecef; border-radius:.75rem;}
                            .history-wrapper thead th {position:sticky; top:0; background:#f8f9fa; z-index:1; box-shadow:0 1px 0 #dee2e6;}
                            .history-table td, .history-table th {white-space:nowrap;}
                            .history-table .cell-route {white-space:normal; font-size:.85rem;}
                            .history-filters .form-control, .history-filters .form-select {height:32px; padding:.25rem .5rem; font-size:.75rem;}
                            .history-pill {background:#eef3ff; border-radius:1rem; padding:.15rem .55rem; font-size:.7rem; font-weight:500; display:inline-flex; gap:.35rem; align-items:center;}
                            .badge-count {font-size:.65rem; letter-spacing:.5px;}
                        </style>
                        <div class="d-flex flex-wrap justify-content-between align-items-start gap-3 mb-3">
                            <div>
                                <h5 class="mb-1">Notification history <small class="text-muted">(latest 50)</small></h5>
                                <div class="small text-muted">Showing up to the 50 latest notifications</div>
                            </div>
                            <div class="history-filters d-flex flex-wrap gap-2 align-items-center">
                                <input id="histSearch" type="text" class="form-control" placeholder="Search location / car" style="min-width:160px;" aria-label="Search history">
                                <select id="histTime" class="form-select" aria-label="Filter time range">
                                    <option value="all" selected>All time</option>
                                    <option value="24h">Last 24h</option>
                                    <option value="7d">Last 7 days</option>
                                </select>
                                <button id="histReset" class="btn btn-outline-secondary btn-sm" type="button">Reset</button>
                                <span class="badge bg-info badge-count" id="histCount">{{ notified_history|length }}</span>
                            </div>
                        </div>
                        <div class="history-wrapper">
                            <table class="table table-sm align-middle history-table mb-0">
                                <thead>
                                    <tr>
                                        <th style="width:26px;" title="Index">#</th>
                                        <th>Notified</th>
                                        <th>Route</th>
                                        <th>Pickup</th>
                                        <th>Return</th>
                                        <th>Car</th>
                                        <th class="text-end">Trip</th>
                                    </tr>
                                </thead>
                                <tbody id="histBody">
                                    {% for n in notified_history %}
                                    <tr data-notified="{{ n.notified_at|date:'c' }}">
                                        <td class="text-muted small">{{ forloop.counter }}</td>
                                        <td><span class="d-block small fw-semibold">{{ n.notified_at|date:"Y-m-d H:i" }}</span></td>
                                        <td class="cell-route" style="min-width:200px;">
                                            <strong>{{ n.pickup_location_name }}</strong><br>
                                            <span class="text-muted">→ {{ n.return_location_name }}</span>
                                        </td>
                                        <td><span class="d-block small">{% if n.available_at %}{{ n.available_at|date:"Y-m-d H:i" }}{% endif %}</span></td>
                                        <td><span class="d-block small text-muted">{% if n.latest_return %}{{ n.latest_return|date:"Y-m-d H:i" }}{% endif %}</span></td>
                                        <td style="min-width:160px;"><span class="small">{{ n.car_type }}</span></td>
                                        <td class="text-end">
                                            {% if n.distance or n.travel_time_hours %}
                                                <span class="history-pill">{% if n.distance %}{{ n.distance|floatformat:0 }} km{% endif %}{% if n.distance and n.travel_time_hours %}<span class="text-muted">/</span>{% endif %}{% if n.travel_time_hours %}{{ n.travel_time_hours }} h{% endif %}</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% empty %}
                    <tr><td colspan="7" class="text-muted">No notifications yet.</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-2 flex-wrap gap-2">
                <p class="text-muted small mb-0">Filtering is local in your browser.</p>
                <button id="histScrollTop" class="btn btn-light btn-sm" type="button">Top</button>
                        </div>
                        <script>
                            (function(){
                              const q = document.getElementById('histSearch');
                              const selTime = document.getElementById('histTime');
                              const reset = document.getElementById('histReset');
                              const body = document.getElementById('histBody');
                              const count = document.getElementById('histCount');
                              const scrollTopBtn = document.getElementById('histScrollTop');
                              const wrapper = document.querySelector('.history-wrapper');

                              function apply(){
                                const term = q.value.trim().toLowerCase();
                                const now = new Date();
                                let visible = 0;
                                const limit = selTime.value;
                                Array.from(body.querySelectorAll('tr')).forEach(tr => {
                                  if(!tr.dataset.notified) return; // skip empty row
                                  const text = tr.innerText.toLowerCase();
                                  let show = true;
                                  if(term){
                                    show = text.indexOf(term) !== -1;
                                  }
                                  if(show && limit !== 'all'){
                                    const notifiedISO = tr.dataset.notified;
                                    const dt = new Date(notifiedISO);
                                    if(limit === '24h'){
                                      show = (now - dt) <= 24*3600*1000;
                                    } else if(limit === '7d'){
                                      show = (now - dt) <= 7*24*3600*1000;
                                    }
                                  }
                                  tr.style.display = show ? '' : 'none';
                                  if(show) visible++;
                                });
                                count.textContent = visible;
                              }
                              q.addEventListener('input', apply);
                              selTime.addEventListener('change', apply);
                              reset.addEventListener('click', ()=>{ q.value=''; selTime.value='all'; apply(); });
                              scrollTopBtn.addEventListener('click', ()=>{ wrapper.scrollTo({top:0, behavior:'smooth'}); });
                            })();
                        </script>
                    </div>
    </div>
</div>
{% endblock %}
